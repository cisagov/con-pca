AWSTemplateFormatVersion: "2010-09-09"
Description: Core Resources for Application (terraform-backend, ecr repositories)
Parameters:
    ENV:
        Type: String
        AllowedValues:
            - dev
            - stage
            - prod
        Description: Environment

    LIFECYCLE:
        Type: String
        Description: Lifecycle policy for repositories
        Default: "{\"rules\": [ { \"rulePriority\": 1, \"description\": \"Keep only one untagged image, expire all others\", \"selection\": { \"tagStatus\": \"untagged\", \"countType\": \"imageCountMoreThan\", \"countNumber\": 1 }, \"action\": { \"type\": \"expire\" } } ]\r\n}"
Resources:
    WebRepo:
        Type: AWS::ECR::Repository
        Properties:
            RepositoryName: con-pca-web
            LifecyclePolicy:
                LifecyclePolicyText: !Ref LIFECYCLE

    GophishRepo:
        Type: AWS::ECR::Repository
        Properties:
            RepositoryName: con-pca-gophish
            LifecyclePolicy:
                LifecyclePolicyText: !Ref LIFECYCLE

    ApiRepo:
        Type: AWS::ECR::Repository
        Properties:
            RepositoryName: con-pca-api
            LifecyclePolicy:
                LifecyclePolicyText: !Ref LIFECYCLE

    ReportsRepo:
        Type: AWS::ECR::Repository
        Properties:
            RepositoryName: con-pca-reports
            LifecyclePolicy:
                LifecyclePolicyText: !Ref LIFECYCLE

    TerraformBackend:
        Type: AWS::S3::Bucket
        Properties:
            AccessControl: Private
            BucketEncryption:
                ServerSideEncryptionConfiguration:
                    - ServerSideEncryptionByDefault:
                        SSEAlgorithm: AES256
            BucketName: !Sub "con-pca-${ENV}-tf-backend"
